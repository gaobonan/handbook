# 工作流管理

工作流管理包含对任务定义, 工作流模版和工作流实例的管理. 

其中, 任务定义是对基本任务步骤的描述, 定义了任务执行的镜像, 入口, 输入/输出参数等; 工作流模版是由多个任务模版组成的有向无环图, 定义了一个由基本步骤组合而成的复杂工作; 工作流实例是由工作流模版创建的运行实例.

因此, 创建并执行工作流主要包含三部分工作:

1. 创建任务定义, 描述如何处理一个步骤 (或使用已共享任务定义, 即将支持);
2. 创建工作流模版, 描述如何用多个任务组合完成复杂工作;
3. 执行参数和配置, 运行工作流实例.

## 创建任务定义

在工作流管理页面, 切换至任务定义列表, 点击按钮新建任务定义: 

![](/images/ch-05/5.6/new-task.png)

### 选择镜像

任务定义可以选用与工作台和训练相同的公开镜像, 也可以使用自定义镜像或直接输入镜像地址: 

![](/images/ch-05/5.6/new-task-image.png)

### 配置任务定义

#### 配置执行入口

任务定义的执行入口与训练类似. 这里可以引用输入参数, 形如 `{{inputs.parameters.param}}`. 运行时, `{{ }}` 中的内容会被替换为参数 `param` 的取值. 如下图中任务定义, 若执行时传入 `param` 的值为 `bye world`, 则运行时的执行入口为 `echo "bye world" && ...`.

#### 配置输入参数

这里声明的输入参数, 可在任务执行入口或任务脚本中使用, 默认值可以留空, 可以声明多个输入参数, 如下图所示.

#### 配置输出参数

输出参数传递方式较为特殊, 任务容器在运行时将要输出的内容写入某一文件, 配置任务定义时需指明该文件路径. 例如下图中的执行入口向文件 `/result` 中写入内容 `done`, 这就是输出参数 `result` 在该结点运行结束后的取值.

一个完整的任务配置如下图:

![](/images/ch-05/5.6/new-task-config.png)

创建成功后可以在任务定义列表看到新建的任务定义:

![](/images/ch-05/5.6/task-list.png)

## 创建工作流模版

切换至工作流模版列表, 点击按钮新建工作流模版. 

### 添加任务定义或子模版

下图工作流模版配置页面中, 左侧为可选择的任务定义列表和已定义的其它工作流模版列表, 点击任务定义或模版名称, 可将其添加到中间工作流配置面板, 作为新工作流模版的一个结点:

![](/images/ch-05/5.6/new-template-select-task.png)

> **[info] Tips:**
>
> 同一个工作流模版中可以有多个结点使用相同的任务定义或子模版, 但同一工作流模版各结点不能重名

### 连接模版结点

依次添加多个任务定义或子模版至中部工作流配置面板后, 可根据任务设计, 调整各结点的位置并用箭头连接有执行依赖关系的结点. 这里的依赖关系指: **箭头由结点 A 指向结点 B, 表示结点 A 执行结束后才能开始执行结点 B**. 结点之间的连接不能形成环, 即最终整体工作流模版应为一个**有向无环图**.

![](/images/ch-05/5.6/new-template-connect.png)

> **[info] Tips:**
> 
> 选中一个结点按 Delete 键可以将其删除

### 绑定输入参数

任务或子模版声明的输入参数需要绑定来源, 可以将某些结点的输出参数, 或一个全局输入参数, 绑定至该结点的一个输入参数. 运行时, 该输入参数的取值即为绑定的参数的实际取值.

> **[warning] Warning:**
> 
> 结点的输入参数如果没有指定默认值, 则必须进行绑定

#### 引用依赖结点的输出

如果结点 B 直接或间接地依赖结点 A, 则可将结点 A 的任一输出参数值用作结点 B 的任一输入参数值. 以上图连接为例, 如要将 `task-demo` 结点的输出参数 `result` 作为 `echo` 结点输入参数 `word` 的值, 则选中 `echo` 结点, 在右侧输入绑定面板即可列出 `echo` 结点的输入参数列表, 点击 `word` 参数右侧下拉框可以看到可选的其它结点的输出参数列表:

![](/images/ch-05/5.6/new-template-input-output.png)

#### 声明并引用全局输入参数

可以为工作流模版声明全局参数, 之后所有结点都可以将此全局参数值用作其输入参数值. 仍以上图连接为例, 创建全局参数并作为结点 `tmpl-echo2-3` 的输入参数.

首先点击 [创建全局参数] 按钮声明全局参数 `global-param`:

![](/images/ch-05/5.6/new-template-global-param.png)

之后选中结点 `tmpl-echo2-3`, 即可在右侧输入绑定面板的下拉框中看到全局输入参数列表, 其中包括 `global-param`:

![](/images/ch-05/5.6/new-template-global-input.png)

### 绑定输出参数

输入参数绑定结束, 点击面板右侧下一步, 可以绑定输出参数. 即: 将结点的一些输出参数声明为工作流模版的全局输出. 输出参数绑定是可选的.

首先需要声明全局输出参数, 可以声明多个全局输出参数:

![](/images/ch-05/5.6/new-template-global-result.png)

之后右侧变为输出参数绑定面板, 列出了所有全局输出参数, 可以用类似绑定输入参数的方式，选择某个结点的某个输出，绑定至该全局输出:

![](/images/ch-05/5.6/new-template-output-redirect.png)

到这里, 一个工作流模版就创建完成了, 可以在工作流模版列表页看到新创建的模版:

![](/images/ch-05/5.6/template-list.png)

## 创建并运行工作流实例

切换至工作流列表标签页, 点击新建工作流, 输入名称后进入模版选择页, 选择一个工作流模版:

![](/images/ch-05/5.6/new-instance-use-template.png)

为每个全局输入参数指定一个值, 也可以按需修改超时时间:

![](/images/ch-05/5.6/new-instance-input.png)

为每一个任务定义指定运行时的资源套餐:

![](/images/ch-05/5.6/new-instance-package.png)

创建成功后, 可以在工作流列表中看到新建的工作流实例, 并可点击按钮启动工作流:

![](/images/ch-05/5.6/instance-list.png)
